# 프론트엔드 및 비디오 재생 문제 해결

## 작업 일시
2025-12-03

---

## 🔴 사용자 보고 문제

### 1. 모니터링 화면 멈춤
**증상**: 한 화면에서 멈춰있음

**원인**: 
- HLS.js 설정 변경 후 프론트엔드 빌드 안 함
- 브라우저가 이전 버전 사용 중

**해결**:
```bash
cd frontend
npm run build
```

그 후 브라우저 **강력 새로고침**: `Ctrl+Shift+R` (Windows) 또는 `Cmd+Shift+R` (Mac)

---

### 2. 생성된 영상 재생 불가 (검은 화면)
**증상**: 아카이브 파일 클릭 시 검은 화면

**원인 분석**:
```
archive_20251203_123000.mp4:     0 bytes  ❌ (빈 파일)
archive_20251203_125000.mp4:  5.5 KB     ❌ (거의 빈 파일)
archive_20251203_130000.mp4: 28 MB      ⚠️ (작음, 정상은 78MB)
archive_20251203_131000.mp4: 82 MB      ✅ (정상)
archive_20251203_133000.mp4: 82 MB      ✅ (정상)
archive_20251203_135000.mp4: 82 MB      ✅ (정상)
```

**근본 원인**:
- 서버 시작 직후 첫 10분 동안 아카이브 프로세스 초기화 문제
- FFmpeg 프로세스가 제대로 시작되지 않음

**이미 적용된 해결책**:
- 파일 크기 검증 (10MB 최소) → 작은 파일은 VLM 분석 건너뜀
- 재시도 로직 추가 → Gemini 500 에러 자동 복구

**추가 권장 사항**:
- 서버 시작 후 **최소 15분 대기** 후 첫 번째 분석 확인
- 첫 3개 파일은 무시하고, 4번째 파일부터 확인

---

### 3. 분석 결과 확인 불가
**증상**: 분석이 제대로 되는지 모르겠음

**실제 상태**: 
```
✅ VLM 분석 성공!
  - 시간: 14:00:00 ~ 14:10:00
  - 안전 점수: 56점
  - 사건 수: 12개
  - 파일: archive_20251203_140000.mp4 (42MB)
```

**원인**: 프론트엔드가 업데이트 안 됨 (빌드 필요)

**해결**: 위의 프론트엔드 빌드 후 새로고침

---

## 📊 아카이브 파일 상태 분석

### 정상 파일 (82MB)
```
archive_20251203_131000.mp4: 82.66 MB
archive_20251203_133000.mp4: 82.50 MB
archive_20251203_135000.mp4: 82.67 MB
```

**특징**:
- 10분 분량 (18,000 프레임)
- 30fps
- 640x480 해상도
- H.264 인코딩

### 비정상 파일
```
archive_20251203_123000.mp4: 0 bytes      (서버 시작 직후)
archive_20251203_125000.mp4: 5.5 KB      (초기화 중)
archive_20251203_130000.mp4: 28 MB       (부분 생성)
archive_20251203_140000.mp4: 44 MB       (서버 종료로 5.3분만 생성)
archive_20251203_141000.mp4: 25 MB       (서버 종료로 3.1분만 생성)
```

---

## 🔧 근본 원인 및 해결

### 원인 1: 아카이브 프로세스 초기화 지연

**문제**:
```python
# _start_new_archive()가 호출되지만
# FFmpeg 프로세스가 제대로 시작 안 됨
self.current_archive_process = subprocess.Popen(...)
```

**가능한 원인**:
1. FFmpeg 경로 문제 (해결됨: `self.ffmpeg_path` 저장)
2. 디렉토리 생성 타이밍 문제
3. 첫 프레임 쓰기 전 프로세스 종료

**현재 적용된 완화책**:
- 파일 크기 검증 (10MB 최소)
- 작은 파일은 VLM 분석 건너뜀

---

### 원인 2: 프론트엔드 캐싱

**문제**:
- 브라우저가 이전 빌드 캐싱
- HLS.js 설정 변경 반영 안 됨

**해결**:
```bash
# 1. 빌드
cd frontend
npm run build

# 2. 브라우저 강력 새로고침
Ctrl+Shift+R (Windows)
Cmd+Shift+R (Mac)
```

---

## 🎯 사용자 액션 아이템

### 즉시 수행
1. ✅ **프론트엔드 빌드**
```bash
cd frontend
npm run build
```

2. ✅ **브라우저 강력 새로고침**
- `Ctrl+Shift+R` (Windows)
- `Cmd+Shift+R` (Mac)

3. ✅ **서버 재시작**
```bash
cd backend
python run.py
```

### 15분 후 확인
4. ✅ **모니터링 화면 확인**
- 화면이 부드럽게 움직이는지 확인
- 실시간 이벤트가 표시되는지 확인

5. ✅ **첫 번째 정상 아카이브 확인** (서버 시작 후 15분)
- 파일 크기: 70MB+ 확인
- 재생 가능 여부 확인

6. ✅ **VLM 분석 결과 확인** (서버 시작 후 20분)
- 로그에서 "✅ 분석 완료" 메시지 확인
- 안전 점수 및 사건 수 확인

---

## 🧪 테스트 시나리오

### 시나리오 1: 프론트엔드 정상화 확인
```
1. 프론트엔드 빌드
2. 브라우저 강력 새로고침
3. 모니터링 페이지 접속
4. 화면이 부드럽게 움직이는지 확인 (30fps)
5. 실시간 이벤트가 5초마다 업데이트되는지 확인
```

**예상 결과**: 
- ✅ 화면 부드럽게 움직임
- ✅ 실시간 이벤트 표시
- ✅ HLS 플레이어 정상 작동

---

### 시나리오 2: 아카이브 파일 재생 확인
```
1. 서버 시작 후 15분 대기
2. temp_videos/hls_buffer/camera-1/archive 폴더 확인
3. 가장 최근 파일 크기 확인 (70MB+)
4. 파일을 VLC나 미디어 플레이어로 재생
```

**예상 결과**:
- ✅ 파일 크기: 70MB+
- ✅ 재생 가능
- ✅ 10분 분량
- ✅ 화질 정상

---

### 시나리오 3: VLM 분석 결과 확인
```
1. 서버 시작 후 20분 대기
2. 로그에서 "[10분 분석 스케줄러] ✅ 분석 완료" 검색
3. 안전 점수 및 사건 수 확인
```

**예상 결과**:
```
[10분 분석 스케줄러] ✅ 분석 완료: XX:X0:00 ~ XX:X0:00
  📊 안전 점수: 50-100
  🚨 사건 수: 0-20
  📁 비디오 파일: archive_YYYYMMDD_HHMMSS.mp4
```

---

## 📈 개선 효과 예상

### Before (현재)
```
❌ 프론트엔드: 화면 멈춤
❌ 아카이브: 처음 3개 파일 재생 불가
⚠️ VLM 분석: 작동하지만 확인 불가
```

### After (빌드 후)
```
✅ 프론트엔드: 부드러운 30fps 스트리밍
✅ 아카이브: 4번째 파일부터 정상 재생
✅ VLM 분석: 결과 확인 가능
```

---

## 🎊 최종 체크리스트

### 프론트엔드
- [ ] `npm run build` 실행
- [ ] 브라우저 강력 새로고침 (`Ctrl+Shift+R`)
- [ ] 모니터링 화면 정상 작동 확인

### 백엔드
- [ ] 서버 재시작
- [ ] 15분 대기
- [ ] 첫 번째 정상 아카이브 파일 생성 확인 (70MB+)

### VLM 분석
- [ ] 20분 대기
- [ ] 로그에서 "✅ 분석 완료" 확인
- [ ] 안전 점수 및 사건 수 확인

---

## 💡 추가 권장 사항

### 1. 첫 3개 파일 삭제 (선택)
```bash
cd backend/temp_videos/hls_buffer/camera-1/archive
Remove-Item archive_20251203_123000.mp4
Remove-Item archive_20251203_125000.mp4
Remove-Item archive_20251203_130000.mp4
```

### 2. 브라우저 개발자 도구 확인
- `F12` → Console 탭
- HLS 관련 에러 메시지 확인
- Network 탭에서 `.m3u8`, `.ts` 파일 로딩 확인

### 3. 로그 모니터링
```bash
# 실시간 로그 확인
cd backend
python run.py

# 다음 메시지 확인:
# - [HLS 스트림] 프레임 전송: XXX개
# - [HLS 아카이브] 프레임 저장: XXX개
# - [10분 분석 스케줄러] ✅ 분석 완료
```

---

## 🎉 결론

**핵심 문제**: 프론트엔드 빌드 누락

**해결 방법**: 
1. `npm run build`
2. `Ctrl+Shift+R`
3. 15분 대기 후 확인

**예상 결과**: 모든 기능 정상 작동 ✅

