# 2025-12-05 업데이트: 하이라이트 클립 기능 고도화 및 프로젝트 구조 개선

## 1. 개요
본 문서는 2025년 12월 5일 진행된 **하이라이트 클립 생성 로직의 고도화**, **백엔드/프론트엔드 파일 구조 정리**, 그리고 **배포 준비를 위한 설정 변경** 사항을 정리합니다.

## 2. 주요 변경 사항

### 2.1 하이라이트 클립 생성 로직 개선 (`AnalysisService`)
기존의 단순 클립 저장 방식에서, **이벤트 중요도와 유형에 기반한 조건부 생성 로직**으로 변경하여 사용자가 의미 있는 순간만 모아볼 수 있도록 개선했습니다.

*   **안전 (Safety) 클립 필터링**
    *   **조건:** 이벤트 심각도가 `사고`, `위험`, `주의` 인 경우에만 클립 생성 (`권장` 등급 제외)
    *   **효과:** 불필요한 알림을 줄이고 사용자가 주의해야 할 안전 사고 순간만 집중적으로 제공
*   **발달 (Development) 클립 필터링**
    *   **조건 1 (최초 발생):** 이벤트 제목에 "최초", "처음", "성공", "새로운" 키워드가 포함된 경우 (`sub_category="최초발생"`)
    *   **조건 2 (징후 포착):** AI 분석 결과(`next_stage_signs`)에서 발달 단계 징후가 감지(`present: true`)된 경우 (`sub_category="다음단계징후"`)
    *   **효과:** 아이의 성장에서 놓치지 말아야 할 중요한 마일스톤 자동 기록

### 2.2 썸네일 자동 생성 및 정적 파일 제공
*   **FFmpeg 기반 썸네일 추출**
    *   클립 생성 시점에 FFmpeg를 호출하여 해당 이벤트 구간의 스틸컷을 자동으로 추출하여 저장하는 로직 추가 (`_generate_thumbnail`)
    *   **발달 클립:** 이벤트 시작 5초 후 지점 캡처 (행동이 명확히 드러나는 시점)
    *   **안전 클립:** 이벤트 시작 1초 후 지점 캡처
*   **StaticFiles 마운트 및 URL 변환**
    *   **Backend (`main.py`):** `/videos` 및 `/temp_videos` 경로를 정적 파일 호스팅 경로로 마운트하여 프론트엔드 접근 허용
    *   **URL 변횐:** DB 저장 시 도커 내부 절대 경로(`/app/videos/...`)를 웹 접근 가능한 상대 경로(`/videos/...`)로 변환하여 저장

### 2.3 프론트엔드 뷰어 개선 (`ClipHighlights.tsx`)
*   **미디어 프래그먼트 (Media Fragments) 적용**
    *   별도의 영상 파일 자르기(Trim) 없이, 원본 영상을 그대로 사용하되 브라우저 기능을 활용해 특정 구간만 재생하도록 구현
    *   구현 방식: `<video src="url#t=0,15" ... />` (0초부터 15초(duration)까지 재생 후 정지)
*   **UI/UX:** 실제 DB 데이터를 기반으로 안전/발달 탭 분리 및 썸네일 표시

### 2.4 프로젝트 구조 정리
*   **디렉토리 재배치**
    *   `backend/scripts/`: 각종 유틸리티 스크립트(`download_ffmpeg.py`, `create_live_monitoring_tables.py` 등) 이동
    *   `backend/tests/`: 테스트 코드 및 영상 로드 테스트 파일 이동
    *   `docs/`: 프로젝트 루트 및 각 폴더에 흩어져 있던 문서 파일 통합 (`FRONTEND_STRUCTURE.md` 등)
*   **정리**
    *   불필요한 중복 파일 삭제 (`frontend/.gitignore`, `backend/6.0.0` 등)

---

## 3. 관련 파일
*   `backend/app/services/analysis_service.py`: 클립 생성 및 썸네일 로직, URL 변환 핵심 구현
*   `backend/app/main.py`: StaticFiles 마운트 설정
*   `backend/app/models/clip.py`: 하이라이트 클립 모델 정의
*   `frontend/src/pages/ClipHighlights.tsx`: 클립 뷰어 및 미디어 프래그먼트 재생 구현

## 4. 향후 계획 (Next Steps)
*   프로덕션 배포 시 Nginx 설정을 통해 미디어 파일 서빙 최적화 고려
*   DB에 `start_time` 필드를 추가하여, 0초부터가 아닌 실제 이벤트 발생 시점부터 재생되도록 고도화 필요
