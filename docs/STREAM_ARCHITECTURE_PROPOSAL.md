# 스트림 아키텍처 개선 제안

## 현재 문제점

1. **MJPEG 스트림 재연결 시 초기화 문제**
   - 클라이언트가 재연결할 때마다 스트림이 처음부터 다시 시작됨
   - `FakeLiveStreamGenerator`는 백그라운드에서 계속 실행되지만, MJPEG 엔드포인트는 각 요청마다 새로운 스트림 생성
   - 기술적 한계가 아니라 구현 방식의 문제

2. **홈캠 연동 준비**
   - 현재는 가짜 스트림으로 테스트 중
   - 최종 목표: 실제 홈캠 연동 + 10분 단위 세그먼트 저장 + 메타데이터 추출

## 해결 방안

### 방안 1: 백엔드 스트림 상태 추적 (권장)

**핵심 아이디어**: `FakeLiveStreamGenerator`가 생성한 세그먼트 파일을 직접 스트리밍

#### 장점:
- ✅ 재연결 시에도 현재 재생 중인 세그먼트부터 이어서 재생 가능
- ✅ 10분 단위 세그먼트 파일이 이미 생성되므로 활용 가능
- ✅ 홈캠 연동 시에도 동일한 구조 사용 가능

#### 구현 방법:
1. `FakeLiveStreamGenerator`가 생성한 `segment_*.mp4` 파일을 실시간으로 스트리밍
2. 현재 재생 중인 세그먼트 파일 경로를 추적
3. 클라이언트 재연결 시 현재 세그먼트부터 이어서 재생

```python
# 예시 구조
class SegmentStreamer:
    def __init__(self, camera_id: str):
        self.camera_id = camera_id
        self.current_segment_path = None
        self.current_frame_index = 0
    
    async def stream_current_segment(self):
        # 현재 세그먼트 파일을 프레임 단위로 스트리밍
        # 재연결 시 current_frame_index부터 이어서 재생
        pass
```

### 방안 2: WebSocket 기반 스트리밍

**핵심 아이디어**: WebSocket으로 지속적인 연결 유지

#### 장점:
- ✅ 연결이 끊어지지 않으면 스트림이 계속 이어짐
- ✅ 양방향 통신 가능

#### 단점:
- ❌ 페이지를 벗어나면 여전히 연결이 끊김
- ❌ 구현 복잡도 증가

### 방안 3: 세그먼트 파일 기반 재생 (최종 목표에 가장 적합)

**핵심 아이디어**: 생성된 세그먼트 파일을 순차적으로 재생

#### 장점:
- ✅ 10분 단위 세그먼트가 이미 생성되므로 바로 활용
- ✅ 홈캠 연동 시에도 동일한 방식 사용
- ✅ 재연결 시 현재 시간에 해당하는 세그먼트부터 재생 가능

#### 구현 방법:
1. `FakeLiveStreamGenerator`가 생성한 세그먼트 파일 목록 조회
2. 현재 시간에 해당하는 세그먼트 파일 찾기
3. 해당 세그먼트부터 순차적으로 스트리밍

## 권장 구현 단계

### Phase 1: 세그먼트 파일 기반 스트리밍 (즉시 구현 가능)
1. 현재 생성된 세그먼트 파일 목록 조회 API 추가
2. 현재 시간에 해당하는 세그먼트 파일 찾기
3. 세그먼트 파일을 프레임 단위로 스트리밍하는 엔드포인트 생성
4. 프론트엔드에서 세그먼트 파일 기반 스트림 재생

### Phase 2: 홈캠 연동 준비
1. 실제 카메라 스트림을 받아서 `FakeLiveStreamGenerator`와 동일한 방식으로 처리
2. 10분 단위 세그먼트 생성 로직은 그대로 유지
3. 메타데이터 추출 로직은 그대로 유지

### Phase 3: 최적화
1. 세그먼트 파일 인덱싱
2. 스트림 버퍼링 최적화
3. 재연결 시 정확한 위치부터 재생

## 즉시 적용 가능한 해결책

**세그먼트 파일 기반 스트리밍으로 전환**:
- `FakeLiveStreamGenerator`가 생성한 `segment_*.mp4` 파일을 직접 스트리밍
- 현재 시간에 해당하는 세그먼트 파일부터 재생
- 재연결 시에도 현재 시간의 세그먼트부터 재생하므로 "이어서 재생" 효과

이 방식이면:
1. ✅ 재연결 시 초기화 문제 해결
2. ✅ 10분 단위 세그먼트 활용
3. ✅ 홈캠 연동 시에도 동일한 구조 사용 가능

