
[공통 분석 가이드: 안전 및 출력]

부정 분석 – 안전 분석(safety_analysis)

★ 이 단계에서는 반드시 다음 5가지를 생성해야 한다:
1) environment_risks  
2) critical_events  
3) incident_events (전체 발생 이벤트 기록)  
4) incident_summary (등급별 횟수 + 실제 감점)  
5) safety_score (최종 안전 점수)

------------------------------------
(1) environment_risks
------------------------------------
- 각 위험 요소에 대해 다음 필드를 상세히 기록한다:
  - risk_type: 낙상 / 충돌 / 끼임 / 질식·삼킴 / 화상 / 기타
  - severity: 사고 / 위험 / 주의 / 권장
  - trigger_behavior: 어떤 행동이 위험을 유발했는지
  - environment_factor: 환경적 요인(모서리보호대 없음, 미끄러운 바닥 등)
  - has_safety_device: true/false (안전장치 유무)
  - safety_device_type: 모서리보호대 / 서랍잠금장치 / 문스토퍼 / 계단안전문 / 미끄럼방지매트 / 기타
  - comment: 이유 및 개선점
- **작성 시 주의사항**: 앞서 제시된 `[이 단계에서 특히 중요한 안전사고 위험 포인트]` 섹션의 내용을 우선적으로 참고하여, 해당 월령에 특화된 위험을 식별한다.
- 보호자의 동반 여부와 개입 방식을 관찰하여 `adult_presence`와 `overall_safety_level`을 평가한다.

------------------------------------
(2) critical_events
------------------------------------
- 실제 사고 또는 사고 직전 상황(심각도 '사고' 또는 '위험')을 기록한다.
- event_type: 실제사고 / 사고직전위험상황
- timestamp_range: **반드시 HH:MM:SS-HH:MM:SS 형식으로 기록** (예: "00:00:05-00:00:10"). 비디오 전체 길이는 메타데이터의 video_total_time을 참고하라.
- description: 상황 설명
- estimated_outcome: 큰부상가능 / 경미한부상가능 / 놀람·정서적스트레스 / 기타

------------------------------------
(3) incident_events  (감점 계산용 - 전체 이벤트 기록)
------------------------------------
⚠️ **중요**: incident_events는 감점 로직을 위한 기초 데이터입니다.
- 영상에서 관찰된 모든 '사고·위험·주의·권장' 이벤트를 1개씩 전부 기록한다.
- **사용처**: safety_score 계산, incident_summary 생성
- **필수 필드**:
  - event_id: "E001", "E002" 등 순차 부여 (감점 계산 시 참조용)
  - severity: 사고 / 위험 / 주의 / 권장
  - timestamp_range: **반드시 HH:MM:SS-HH:MM:SS 형식으로 기록**
  - description: 상세 설명
  - has_safety_device: true/false (안전장치 유무 - 감점 계산에 영향)
- **주의**: incident_events와 safety_events는 별도로 생성해야 합니다. 
  incident_events는 감점용, safety_events는 타임라인 표시용입니다.

------------------------------------
(4) incident_summary  (등급별 횟수 + 감점 적용)
------------------------------------
각 severity 등급별로 다음을 기록한다:
- severity: 사고 / 위험 / 주의 / 권장
- occurrences: 해당 등급이 영상에서 총 몇 번 나타났는지 (incident_events에서 계산)
- applied_deduction: 실제 감점 값

------------------------------------
(5) 안전도 점수 계산 규칙 (safety_score)
------------------------------------

기본 점수 = 100점

감점 규칙:
- 사고: -50점 (최대 1회만 감점 적용)
- 위험: -30점 (최대 1회만 감점 적용)
- 주의: -10점 (최대 1회만 감점 적용)
- 권장: -2점 × 발생 건수 (최대 -16점)

계산 방식:
- incident_events → 모든 기록을 반영하여 각 등급별 occurrences 계산
- incident_summary → 감점 규칙에 따라 applied_deduction 생성
- safety_score = 100 + 모든 applied_deduction 합계
- 최종 점수는 50점보다 낮아지면 50점으로 처리한다.

------------------------------------
(6) safety_events (타임라인/DB 저장용 안전 이벤트)
------------------------------------
⚠️ **중요**: safety_events는 Dashboard 타임라인 표시 및 DB 저장을 위한 상세 데이터입니다.
- **사용처**: Dashboard 타임라인(빨간색/노란색), SafetyEvent 테이블 저장, SafetyReport 사고 유형 차트
- **incident_events와의 차이점**:
  - incident_events: 감점 계산용 (event_id, severity, has_safety_device 중심)
  - safety_events: UI 표시용 (title, location, description, resolved 중심)
- 각 이벤트는 다음 필드를 포함해야 한다:
  - severity: "위험" / "주의" / "권장" (타임라인 색상 결정)
  - title: 짧고 명확한 제목 (예: "주방 근처 접근", "낙상 위험") - **필수**
  - description: 상세 설명 (예: "데드존에 3회 접근했습니다.") - **필수**
  - location: 발생 위치 (예: "주방 입구", "거실") - 장소별 통계용 - **필수**
  - timestamp_range: **반드시 HH:MM:SS-HH:MM:SS 형식** (예: "00:01:20-00:01:25") - **필수**
  - resolved: false (기본값, 해결 여부는 사용자가 나중에 체크)
- **주의**: safety_events는 incident_events와 별도로 생성하며, 
  같은 사건이라도 UI에 표시하기 좋은 형태로 title과 location을 명확히 작성해야 합니다.

------------------------------------
(7) safety_summary (안전 요약)
------------------------------------
- 전체 안전 상황을 요약한 긴 글 (2-3문장)
- 예: "오늘 아이는 전반적으로 안전하게 활동했습니다. 다만 주방 근처 접근 시 주의가 필요합니다."
- Dashboard 메인 화면에 표시될 요약 텍스트

------------------------------------
발달 분석 (development_analysis)
------------------------------------

★ 이 단계에서는 반드시 다음을 생성해야 한다:
1) summary (발달 요약)
2) main_activity (주요 활동)
3) development_score (발달 점수)
4) development_radar_scores (오각형 차트용 점수)
5) development_events (타임라인용 발달 이벤트)
6) skills (관찰된 발달 기술)
7) next_stage_signs (다음 단계 징후)

------------------------------------
(1) main_activity (주요 활동)
------------------------------------
- 영상에서 가장 많이 관찰된 활동을 한 줄로 기록
- 예: "블록 쌓기", "낮잠", "배밀이 연습"
- Dashboard 메인 화면에 표시

------------------------------------
(2) development_score (발달 점수)
------------------------------------
- 전체 발달 수준을 0-100점으로 평가
- 관찰된 발달 기술의 다양성, 빈도, 숙련도를 종합 평가
- DevelopmentReport에 표시

------------------------------------
(3) development_radar_scores (오각형 차트 점수)
------------------------------------
- 5개 영역별로 0-100점 평가:
  - "운동": 대근육/소근육 운동 발달
  - "언어": 언어 이해 및 표현
  - "인지": 인지 능력 및 문제 해결
  - "사회성": 타인과의 상호작용
  - "정서": 정서 표현 및 조절
- DevelopmentReport의 오각형 차트에 사용

------------------------------------
(4) development_events (타임라인용 발달 이벤트)
------------------------------------
- Dashboard 타임라인에 표시될 발달 이벤트를 기록한다.
- 각 이벤트는 다음 필드를 포함해야 한다:
  - category: "운동" / "언어" / "인지" / "사회성"
  - title: 짧고 명확한 제목 (예: "배밀이 연습 (15분)")
  - description: 상세 설명 (예: "대근육 발달 촉진")
  - is_sleep: false (수면 여부, true면 타임라인에서 '수면'으로 묶어서 표시)

------------------------------------
(5) summary (발달 요약)
------------------------------------
- 전체 발달 상황을 요약한 긴 글 (2-3문장)
- 예: "소근육 발달이 눈에 띕니다. 블록 쌓기를 통해 손가락 협응력이 향상되었습니다."
- DevelopmentReport에 표시될 요약 텍스트

------------------------------------
추천 활동 (recommendations)
------------------------------------
- 아이의 현재 발달 수준에 맞는 놀이 활동을 추천한다.
- 각 추천은 다음 필드를 포함해야 한다:
  - title: 활동 이름 (예: "까꿍 놀이", "블록 쌓기")
  - benefit: 발달 영역 (예: "인지", "소근육", "언어", "사회성")
- 2-5개 정도 추천

------------------------------------
하이라이트 클립 (highlight_clips)
------------------------------------
- 영상에서 특별히 주목할 만한 순간을 클립으로 추천한다.
- 각 클립은 다음 필드를 포함해야 한다:
  - title: 클립 제목 (예: "배밀이 2미터 이동 성공!")
  - video_url: 영상 구간 URL (재생 버튼 클릭 시 사용)
  - thumbnail_url: 썸네일 이미지 URL (카드 이미지로 사용)
  - category: "발달" / "안전" (탭 구분용)
- 1-3개 정도 추천

디스클레이머
- `disclaimer` 필드에 아래 문장을 반드시 포함한다:
  "이 평가는 영상 기반 관찰에 따른 참고용 발달·안전 분석이며, 의학적 진단이나 전문 평가를 대체하지 않습니다."

[출력 형식]
- 반드시 아래 스키마를 따르는 **단일 JSON 객체만** 출력한다.
- JSON 외 텍스트(마크다운 코드블록 ```json 등)는 절대 포함하지 않는다.

```json
{
  "meta": {
    "observation_duration_minutes": 10,
    "assumed_stage": "5",
    "age_months": 15
  },
  "stage_consistency": {
    "match_level": "전형적",
    "evidence": ["혼자서 안정적으로 걷는 모습이 관찰됨"],
    "suggested_stage_for_next_analysis": null
  },
  "development_analysis": {
    "summary": "전반적으로 해당 월령에 맞는 발달을 보입니다.",
    "main_activity": "블록 쌓기",
    "development_score": 88,
    "development_radar_scores": {
      "운동": 92,
      "언어": 88,
      "인지": 85,
      "사회성": 90,
      "정서": 87
    },
    "skills": [
      {
        "name": "독립 보행",
        "category": "대근육운동",
        "present": true,
        "frequency": 5,
        "level": "숙련",
        "examples": ["거실에서 주방으로 혼자 걸어감"]
      }
    ],
    "next_stage_signs": [],
    "development_events": [
      {
        "category": "운동",
        "title": "배밀이 연습 (15분)",
        "description": "대근육 발달 촉진",
        "is_sleep": false
      }
    ]
  },
  "safety_analysis": {
    "overall_safety_level": "주의",
    "adult_presence": "자주동반",
    "safety_summary": "오늘 아이는 전반적으로 안전하게 활동했습니다. 다만 주방 근처 접근 시 주의가 필요합니다.",
    "environment_risks": [
      {
        "risk_type": "낙상",
        "severity": "주의",
        "trigger_behavior": "걷다가 장난감 밟음",
        "environment_factor": "바닥에 장난감이 어지러져 있음",
        "has_safety_device": false,
        "safety_device_type": null,
        "comment": "장난감 정리가 필요함"
      }
    ],
    "critical_events": [],
    "incident_events": [
      {
        "event_id": "E001",
        "severity": "주의",
        "timestamp_range": "00:01:20-00:01:25",
        "description": "장난감을 밟고 비틀거림",
        "has_safety_device": false
      }
    ],
    "safety_events": [
      {
        "severity": "주의",
        "title": "주방 근처 접근",
        "description": "데드존에 3회 접근했습니다.",
        "location": "주방 입구",
        "timestamp_range": "00:01:20-00:01:25",
        "resolved": false
      }
    ],
    "incident_summary": [
      {
        "severity": "주의",
        "occurrences": 1,
        "applied_deduction": -10
      }
    ],
    "safety_score": 90
  },
  "recommendations": [
    {
      "title": "까꿍 놀이",
      "benefit": "인지"
    },
    {
      "title": "블록 쌓기",
      "benefit": "소근육"
    }
  ],
  "highlight_clips": [
    {
      "title": "배밀이 2미터 이동 성공!",
      "video_url": "video_segment_url_here",
      "thumbnail_url": "thumbnail_url_here",
      "category": "발달"
    }
  ],
  "disclaimer": "이 평가는 영상 기반 관찰에 따른 참고용 발달·안전 분석이며, 의학적 진단이나 전문 평가를 대체하지 않습니다."
}
```
